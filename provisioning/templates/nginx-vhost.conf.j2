{% if item.server_name_redirect is defined %}
server {
    listen       80;
    server_name  {{ item.server_name_redirect }};
    return       301 http://{{ item.server_name }}$request_uri;
}
{% endif %}

server {
    listen {{ item.listen | default("80") }};

    server_name {{ item.server_name }};
    root {{ item.root }};
    error_log /var/log/nginx/error.log debug;
    # strip app.php/ prefix if it is present
    {% if item.is_dev is defined and item.is_dev %}
    rewrite ^/app_dev\.php/?(.*)$ /$1 permanent;
    {% else %}
    rewrite ^/app\.php/?(.*)$ /$1 permanent;
    {% endif %}

    location / {
    {% if item.is_dev is defined and item.is_dev %}
        index app_dev.php;
    {% else %}
        index app.php;
    {% endif %}
        try_files $uri @rewriteapp;
    }

    location @rewriteapp {
    {% if item.is_dev is defined and item.is_dev %}
        rewrite ^(.*)$ /app_dev.php/$1 last;
    {% else %}
        rewrite ^(.*)$ /app.php/$1 last;
    {% endif %}
    }

    # pass the PHP scripts to FastCGI server from upstream phpfcgi
    location ~ ^/(app|app_dev|config)\.php(/|$) {
        fastcgi_pass unix:/var/run/php5-fpm.sock;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;
        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param  HTTPS off;
    }
}